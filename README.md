# xk6-thrift

A k6 extension for load testing Thrift RPC service.

> [!INFO]
> This document is in progress of brushing up

## Get started

First of all, prepare your Thrift IDL and run servers implementing it.
In the following example, let's assume IDL is like this.

```thrift
service TestService {
    string simpleCall(1: string id);
}
```

Then, create your load testing file with JavaScript.

```javascript
import thrift from 'k6/x/thrift';
import ttypes from 'k6/x/thrift/ttypes';

export default function() {
  const method = "simpleCall";
  // prepare arguments as map.
  const values = {};
  // "1" means ID of the argument.
  values[1] = ttypes.newTString("ID");
  // wrap map of request arguments.
  const req = ttypes.newTRequest(values);

  thrift.call(method, req);
}
```

What you have to configure are...
- Specify Thrift service method name.
  - `simpleCall` in the above examlpe.
- Build request body with `ttypes.newTXxx()` method.
  - For the detailed usage, see [Detailed usage](#detailed-usage) section.
  - Wrap body 

Now it's ready to call Thrift RPC service.

See [scripts/](./scripts/) directory for more examples.

## Requirements

- Golang v1.23 or higher (tested in this version)

## Features

- Thrift using HTTP as transport layer.
- Thrift types
  - string (Use `ttypes.newTString()`)
  - boolean (Use `ttypes.newTBool()`)
  - map (Use `ttypes.newTMap()`)
  - struct (Use `ttypes.newTStruct()`)

## Features (planning)

- Thrift using TCP as transport layer.
- Thrift types
  - numbers such as int16, int32 etc
  - list
  - set
  - uuid
- schema referencing by JSON generated by Thrift compiler
- check Thrift response mechanism

## Detailed usage

TBD.

## Development

### How to use in local

Server implementation is included in this repository.
See [idl/](./idl/) directory for Thrift IDL and [server/](./server/) directory for server implementation.
Only thing you have to use is installing Java 17 or higher and run server on it.
[SDKMAIN!](https://sdkman.io/) is the recommended way to install Java.

After that, do the following command on root directory of this repository.
Thrift server will be started on `port 8080`, `path /thrift`.

```shell
$ ./server/gradlew run -p server/server/
# check server is running on another terminal
$ curl -v http://localhost:8080/health
```

Or you can use any server implementation you want to use.
Please compile Thrift IDL and run server.

## LICENSE

Apache License 2.0. See [LICENSE](./LICENSE).

## Contribution

Any issue report, feedback, feature request or pull request is welcome.
Please feel free to open an issue or submit pull request.

